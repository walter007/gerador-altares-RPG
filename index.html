<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gerador de Miss√µes - Altaris</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light p-4">

<div class="container">

  <!-- MENU PRINCIPAL -->
  <h1 class="text-center mb-4">Gerador Altaris</h1>

  <div id="menu" class="container d-grid gap-3">
    <button class="btn btn-primary" onclick="abrirSecao('missoes')">üìú Miss√µes</button>
    <button class="btn btn-secondary" onclick="abrirSecao('sec-encontros')">‚öîÔ∏è Encontros</button>
    <button class="btn btn-success" onclick="abrirSecao('sec-pi')">üåç Pontos de Interesse</button>
    <button class="btn btn-info" onclick="abrirSecao('sec-boatos')">üí¨ Boatos</button>
    <button class="btn btn-dark" onclick="abrirSecao('sec-dungeon')">üóùÔ∏è Dungeon</button>
    <button class="btn btn-primary" onclick="abrirSecao('sec-cidade')">üèôÔ∏è Cidades</button>
    <button class="btn btn-secondary" onclick="abrirSecao('sec-diario')">üìò Di√°rio</button>
    <button class="btn btn-warning" onclick="abrirSecao('sec-oraculo')">üîÆ Or√°culo</button>
    <button class="btn btn-warning" onclick="abrirSecao('sec-tabelas-oraculo')">üìö Tabelas do Or√°culo</button>
    <button class="btn btn-dark w-100 my-2" onclick="abrirSecao('pnjSection')">üë§ PNJs </button>
    <button class="btn btn-dark w-100 my-2" onclick="abrirSecao('pjSection')">üë§ PJs </button>
    <button class="btn btn-warning" onclick="abrirSecao('sec-campanhas')">üìÅ Salvar / Carregar Campanha</button>

  </div>

<section id="pjSection" class="secao" style="display:none">

  <h3 class="mt-3">Personagens Jogadores (PJ)</h3>

  <button class="btn btn-success my-2" onclick="abrirCriarPJ()">‚ûï Criar PJ</button>

  <ul id="listaPJs" class="list-group"></ul>

</section>

<!--    SECTION: PNJs          -->
<section id="pnjSection" class="secao" style="display:none">
  <h3 class="mb-3">üë§ Gerenciamento de PNJs</h3>

  <div class="d-flex gap-2 mb-3">
    <button class="btn btn-primary" onclick="gerarPNJ_UI()">‚ûï Criar PNJ</button>
  </div>

  <div id="pnjLista" class="mt-3"></div>

  <button class="btn btn-dark mt-4" onclick="voltarMenu()">‚¨Ö Voltar</button>
</section>

<!-- ================= SE√á√ÉO OR√ÅCULO (Nova!) ================= -->
<div id="sec-oraculo" class="secao" style="display:none;">
  <h2>üîÆ Or√°culo do Destino</h2>

  <p class="text-muted">Sistema completo baseado no Mythic.</p>

  <div class="card p-3 mb-3">
    <h5>‚öñÔ∏è Consulta ao Or√°culo</h5>

    <label class="fw-bold">Probabilidade</label>
    <select id="oraculoProb" class="form-select mb-2">
        <option value="50_50">50/50</option>
        <option value="provavel">Prov√°vel</option>
        <option value="muito_provavel">Muito Prov√°vel</option>
        <option value="quase_certeza">Quase Certeza</option>
        <option value="certeza">Certeza</option>
        <option value="improvavel">Improv√°vel</option>
        <option value="muito_improvavel">Muito Improv√°vel</option>
        <option value="quase_impossivel">Quase Imposs√≠vel</option>
        <option value="impossivel">Imposs√≠vel</option>
    </select>

    <label class="fw-bold mt-2">Fator Caos</label>
    <div class="d-flex align-items-center gap-2">
      <input id="oraculoChaos" type="number" min="1" max="10" value="5" class="form-control w-auto">
      <small class="text-muted">(1‚Äì10)</small>
    </div>

    <button class="btn btn-primary mt-3" onclick="consultarDestino()">üîç Consultar Destino</button>
    <button id="salvarOraculoBtn" class="btn btn-success mt-3" style="display:none;" onclick="salvarResultadoOraculo()">üíæ Salvar no Di√°rio</button>

    <div id="resultadoOraculo" class="mt-3" style="display:none;"></div>
  </div>

  <button class="btn btn-outline-secondary mt-3" onclick="voltarMenu()">‚¨Ö Voltar</button>
</div>

  <!-- ================= SE√á√ÉO TABELAS DO OR√ÅCULO ================= -->
<div id="sec-tabelas-oraculo" class="secao" style="display:none;">
  <h2>üìö Tabelas do Or√°culo</h2>

  <p class="text-muted">Essas tabelas s√£o salvas por campanha e usadas nos eventos aleat√≥rios.</p>

  <!-- ==== TRAMAS ==== -->
  <h4>üìò Tabela de Tramas</h4>
  <div class="input-group mb-2">
    <input id="novaTrama" type="text" class="form-control" placeholder="Descri√ß√£o da trama">
    <button class="btn btn-success" onclick="adicionarTrama()">Adicionar</button>
  </div>
  <ul id="listaTramas" class="list-group mb-3"></ul>

  <!-- ==== PNJ ==== -->
  <h4>üßç Tabela de PNJ</h4>
  <div class="input-group mb-2">
    <input id="novoPNJ" type="text" class="form-control" placeholder="Nome do PNJ">
    <button class="btn btn-success" onclick="adicionarPNJ()">Adicionar</button>
  </div>
  <ul id="listaPNJ" class="list-group mb-3"></ul>

  <!-- ==== PJ ==== -->
  <h4>üßù Tabela de PJ</h4>
  <div class="input-group mb-2">
    <input id="novoPJ" type="text" class="form-control" placeholder="Nome do personagem jogador">
    <button class="btn btn-success" onclick="adicionarPJ()">Adicionar</button>
  </div>
  <ul id="listaPJ" class="list-group mb-3"></ul>

  <button class="btn btn-outline-secondary mt-3" onclick="voltarMenu()">‚¨Ö Voltar</button>
</div>

  <!-- ================= SE√á√ÉO DI√ÅRIO (Atualizada) ================= -->
<div id="sec-diario" class="secao" style="display:none;">
  <h2>üìò Di√°rio da Campanha</h2>

  <!-- Cena Atual -->
  <div id="cenaAtualBox" class="alert alert-info" style="display:none;">
    <b>üé¨ Cena Atual:</b> <span id="cenaAtualTexto"></span>
  </div>

  <button class="btn btn-primary w-100 mb-3" onclick="novaCena()">‚úèÔ∏è Criar Nova Cena</button>

  <div id="editorCena" class="card p-3 mb-3" style="display:none;">
    <label class="fw-bold">T√≠tulo da Cena:</label>
    <input id="diarioTitulo" class="form-control mb-2">

    <label class="fw-bold">Descri√ß√£o:</label>
    <textarea id="diarioTexto" class="form-control" rows="6"></textarea>

    <button class="btn btn-success mt-3" onclick="salvarCena()">üíæ Salvar Cena</button>
    <button class="btn btn-outline-secondary mt-3" onclick="cancelarCena()">‚ùå Cancelar</button>
  </div>

  <h4>üìú Cenas Registradas</h4>
  <ul id="listaCenas" class="list-group mb-3"></ul>

  <button class="btn btn-danger btn-sm" onclick="limparCenas()">üóëÔ∏è Apagar Tudo</button>
  <button class="btn btn-outline-secondary mt-3" onclick="voltarMenu()">‚¨Ö Voltar</button>
</div>


  <!-- ================= SE√á√ÉO MISS√ïES ================= -->
  <div id="missoes" class="secao" style="display:none;">
    <h2>üìú Miss√µes</h2>

    <ul id="listaMissoesAtivas" class="list-group mb-3"></ul>

    <h4>‚úÖ Miss√µes Conclu√≠das</h4>
    <ul id="listaMissoesConcluidas" class="list-group mb-3"></ul>
    
    <button class="btn btn-primary w-100 mb-3" onclick="gerarMissao()">üé≤ Gerar Miss√£o</button>

    <button class="btn btn-danger w-100 mb-3" onclick="limparHistoricoMissoes()">üóëÔ∏è Limpar Hist√≥rico</button>

    <button class="btn btn-secondary w-100" onclick="voltarMenu()">‚¨ÖÔ∏è Voltar</button>
  </div>


  <!-- ================= SE√á√ÉO ENCONTROS ================= -->
  <div id="sec-encontros" class="secao" style="display:none;">
    <h2>‚öîÔ∏è Encontros</h2>

    <label class="form-label fw-bold">Bioma</label>
    <select id="biomaSelect" class="form-select mb-3">
      <option value="planicie">Plan√≠cie</option>
      <option value="floresta">Floresta</option>
      <option value="selva">Selva</option>
      <option value="deserto">Deserto</option>
      <option value="colina">Colina</option>
      <option value="montanha">Montanha</option>
      <option value="costeiro">Costeiro</option>
      <option value="marinho">Marinho</option>
      <option value="pantano">P√¢ntano</option>
      <option value="tundra">Tundra</option>
    </select>

    <button class="btn btn-primary w-100 mb-3" onclick="gerarEncontro()">Gerar Encontro</button>

    <div id="resultadoEncontro"></div>

    <button class="btn btn-outline-secondary" onclick="voltarMenu()">‚¨Ö Voltar</button>
  </div>


  <!-- ================= SE√á√ÉO PONTOS DE INTERESSE ================= -->
<div id="sec-pi" class="secao" style="display:none;">
  <h2>üåç Pontos de Interesse</h2>

  <label class="form-label fw-bold">Tipo</label>
  <select id="tipoPiSelect" class="form-select mb-3">
    <option value="monstruoso">Monstruoso</option>
    <option value="geografico">Geogr√°fico</option>
    <option value="npc">NPC</option>
    <option value="divino">Divino</option>
    <option value="magico">M√°gico</option>
    <option value="militar">Militar</option>
  </select>

  <label class="form-label fw-bold">Bioma</label>
  <select id="biomaSelectPI" class="form-select mb-3">
    <option value="planicie">Plan√≠cie</option>
    <option value="floresta">Floresta</option>
    <option value="selva">Selva</option>
    <option value="deserto">Deserto</option>
    <option value="colina">Colina</option>
    <option value="montanha">Montanha</option>
    <option value="costeiro">Costeiro</option>
    <option value="marinho">Marinho</option>
    <option value="pantano">P√¢ntano</option>
    <option value="tundra">Tundra</option>
  </select>

  <button class="btn btn-success w-100 mb-3" onclick="gerarPontoInteresse()">üé≤ Gerar Ponto de Interesse</button>

  <div id="resultadoPI" class="card mt-3" style="display:none;">
    <div class="card-body" id="textoPI"></div>
  </div>

  <h4 class="mt-4">üìú Pontos Descobertos</h4>
  <div id="listaPI"></div>

  <button class="btn btn-danger btn-sm mt-2" onclick="limparPI()">Limpar Todos</button>

  <button class="btn btn-outline-secondary mt-3" onclick="voltarMenu()">‚¨Ö Voltar</button>
</div>
  

  <!-- ================= SE√á√ÉO BOATOS ================= -->
  <div id="sec-boatos" class="secao" style="display:none;">
    <h2>üí¨ Boatos</h2>

    <button class="btn btn-warning w-100 mb-3" onclick="gerarBoato()">Gerar Boato</button>

    <h4>Rumores Descobertos</h4>
    <ul id="listaRumores" class="list-group mb-3"></ul>
    <button class="btn btn-danger btn-sm" onclick="limparRumores()">Limpar</button>

    <button class="btn btn-outline-secondary mt-3" onclick="voltarMenu()">‚¨Ö Voltar</button>
  </div>


  <!-- ================= SE√á√ÉO DUNGEON ================= -->
  <div id="sec-dungeon" class="secao" style="display:none;">
    <h2>üóùÔ∏è Dungeon</h2>

    <select id="dungeonSelect" class="form-select mb-3">
      <option value="temploProfanado">Templo Profanado</option>
      <option value="cidadelaAbandonada">Cidadela Abandonada</option>
      <option value="antigoLaboratorio">Antigo Laborat√≥rio</option>
      <option value="calaboucoArruinado">Calabou√ßo Arruinado</option>
      <option value="criptaAssombrada">Cripta Assombrada</option>
      <option value="cavernaComum">Caverna Comum</option>
    </select>

    <h4>üß± Cria√ß√£o de Dungeon</h4>

    <div class="mb-2">
        <button class="btn btn-secondary" onclick="novaDungeon()">Nova Dungeon</button>
        <button class="btn btn-primary" onclick="gerarSalaDungeon()">Gerar Sala</button>
        <button class="btn btn-success" onclick="finalizarDungeon()">Finalizar Dungeon</button>
    </div>

    <div id="dungeonAtual" class="card p-3 mb-3" style="display:none;"></div>

    <h5>Dungeons Criadas</h5>
    <ul id="listaDungeons" class="list-group"></ul>

    <div id="resultadoDungeon"></div>

    <button class="btn btn-outline-secondary" onclick="voltarMenu()">‚¨Ö Voltar</button>
  </div>

  <!-- ================= SE√á√ÉO CAMPANHAS ================= -->
<div id="sec-campanhas" class="secao" style="display:none;">
  <h2>üìÅ Salvar / Carregar Campanha</h2>

  <p><b>Campanha Atual:</b> <span id="campanhaAtualNome"></span></p>

  <h4>Campanhas Existentes</h4>
  <ul id="listaCampanhas" class="list-group mb-3"></ul>

  <div class="input-group mb-3">
    <input id="novaCampanhaNome" type="text" class="form-control" placeholder="Nome da nova campanha">
    <button class="btn btn-success" onclick="criarCampanha()">Criar</button>
  </div>

  <button class="btn btn-outline-secondary" onclick="voltarMenu()">‚¨Ö Voltar</button>
</div>

<!-- ================= SE√á√ÉO CIDADES ================= -->
<div id="sec-cidade" class="secao" style="display:none;">
  <h2>üèôÔ∏è Cidades</h2>

  <button class="btn btn-primary w-100 mb-3" onclick="gerarCidade()">üé≤ Gerar Cidade</button>

  <div id="resultadoCidade" class="card mt-3" style="display:none;">
    <div class="card-body" id="textoCidade"></div>
  </div>

  <h4 class="mt-4">üèõÔ∏è Cidades Descobertas</h4>
  <ul id="listaCidades" class="list-group mb-3"></ul>

  <button class="btn btn-danger btn-sm" onclick="limparCidades()">Limpar Hist√≥rico</button>

  <button class="btn btn-outline-secondary mt-3" onclick="voltarMenu()">‚¨Ö Voltar</button>
</div>

</div>

<div class="modal fade" id="modalDetalhesPNJ" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Detalhes do PNJ</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="conteudoDetalhesPNJ"></div>
    </div>
  </div>
</div>

<div class="modal fade" id="modalEditarPNJ" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Editar PNJ</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="conteudoEditarPNJ"></div>
      <div class="modal-footer">
        <button class="btn btn-success" onclick="salvarEdicaoPNJ()">Salvar</button>
      </div>
    </div>
  </div>
</div>


<div class="modal fade" id="modalCriarPJ">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">

      <div class="modal-header">
        <h5 id="modalCriarPjTitulo" class="modal-title">Criar PJ</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <form id="formCriarPJ">
          <input type="hidden" id="pjEditando">
          <h4>Ficha de Personagem</h4>

          <div class="row">
            <div class="col">
              Nome: <input type="text" class="form-control" id="pjNome" required>
            </div>
            <div class="col">
                Esp√©cie:
                <select id="pjEspecie" class="form-select" onchange="atualizarEspeciePVPE()">
                    <option disabled selected>Escolha...</option>
                    <option value="Ruma">Ruma (10 PV / 10 PE)</option>
                    <option value="Pequenino">Pequenino (8 PV / 12 PE)</option>
                    <option value="Duarvo">Duarvo (13 PV / 7 PE)</option>
                    <option value="Kururuh">Kururuh (7 PV / 13 PE)</option>
                    <option value="Elfo">Elfo (9 PV / 11 PE)</option>
                    <option value="Silfo">Silfo (5 PV / 13 PE)</option>
                    <option value="Akridiano">Akridiano (9 PV / 10 PE)</option>
                    <option value="Diabrante">Diabrante (12 PV / 8 PE)</option>
                    <option value="Arb√≥reo">Arb√≥reo (8 PV / 12 PE)</option>
                    <option value="Felicato">Felicato (10 PV / 11 PE)</option>
                    <option value="Javalique">Javalique (14 PV / 6 PE)</option>
                    <option value="Komodo">Komodo (11 PV / 9 PE)</option>
                </select>
            </div>

            <div class="col">
                Origem:
                <select id="pjOrigem" class="form-select">
                    <option disabled selected>Escolha...</option>
                    <option>Urbano</option>
                    <option>Florestal</option>
                    <option>Campestre</option>
                    <option>Pantanoso</option>
                    <option>Costeiro</option>
                    <option>Des√©rtico</option>
                    <option>Pampeiro</option>
                    <option>Montanh√™s</option>
                    <option>Glacial</option>
                    <option>Vulc√¢nico</option>
                    <option>Subterr√¢neo</option>
                    <option>N√¥made</option>
                </select>
          </div>
          </div>

          <div class="row mt-2">
            <div class="col">
                Classe:
                <select id="pjClasse" class="form-select" onchange="atualizarPVPEClasse()">
                    <option disabled selected>Escolha...</option>
                    <option>Arqueiro</option>
                    <option>Bardo</option>
                    <option>Berserker</option>
                    <option>Cavaleiro</option>
                    <option>Duelista</option>
                    <option>Druida</option>
                    <option>Mago</option>
                    <option>Ladr√£o</option>
                    <option>Patrulheiro</option>
                    <option>Necromante</option>
                    <option>Protetor</option>
                    <option>Soldado</option>
                </select>
            </div>
            <div class="col">
                Foco:
                <select id="pjFoco" class="form-select">
                    <option disabled selected>Escolha...</option>
                    <option>For√ßa</option>
                    <option>Sa√∫de</option>
                    <option>Rapidez</option>
                    <option>Sutileza</option>
                    <option>Concentra√ß√£o</option>
                    <option>Comunica√ß√£o</option>
                </select>
            </div>
            <div class="col">
              Motiva√ß√£o: <input type="text" class="form-control" id="pjMotivacao">
            </div>
          </div>

          <hr>
          <h5>Pontos de Vida</h5>

        <div class="row">
        <div class="col">
            <label class="form-label">PV da Esp√©cie</label>
            <input class="form-control" id="pjPVEspecie">
        </div>

        <div class="col">
            <label class="form-label">PV da Classe</label>
            <input class="form-control" id="pjPVClasse">
        </div>

        <div class="col">
            <label class="form-label">PV de Equipamentos</label>
            <input class="form-control" id="pjPVEquip">
        </div>

        <div class="col">
            <label class="form-label">PV M√°ximo</label>
            <input class="form-control" id="pjPVMax">
        </div>

        <div class="col">
            <label class="form-label">PV Atual</label>
            <input class="form-control" id="pjPVAtual">
        </div>
        </div>


          <hr>
          <h5>Pontos de Energia</h5>

        <div class="row">
        <div class="col">
            <label class="form-label">PE da Esp√©cie</label>
            <input class="form-control" id="pjPEEspecie">
        </div>

        <div class="col">
            <label class="form-label">PE da Classe</label>
            <input class="form-control" id="pjPEClasse">
        </div>

        <div class="col">
            <label class="form-label">PE de Equipamentos</label>
            <input class="form-control" id="pjPEEquip">
        </div>

        <div class="col">
            <label class="form-label">PE M√°ximo</label>
            <input class="form-control" id="pjPEMax">
        </div>

        <div class="col">
            <label class="form-label">PE Atual</label>
            <input class="form-control" id="pjPEAtual">
        </div>
        </div>

          <hr>
          <h5>Armas em M√£os (at√© 3)</h5>

          <div id="pjArmas"></div>
          <button type="button" class="btn btn-secondary mt-2" onclick="abrirEscolhaArma()">Adicionar Arma 2</button>

          <hr>
          <h5>Escudo / Ferramenta (m√∫ltiplos)</h5>
          
          <div id="pjEscudos"></div>
          <button type="button" class="btn btn-secondary mt-2" onclick="adicionarEscudo()">Adicionar Escudo</button>

          <hr>
          <h5>Equipamento Vestido</h5>

          <div id="pjEquipVestido"></div>

         <button type="button" class="btn btn-secondary mt-2" onclick="adicionarVestimenta()">Adicionar Vestimenta</button>

          <hr>
          <h5>Conhecimentos (at√© 8)</h5>
          <div class="d-flex gap-2">
            <select id="pjConhecimentoAdd" class="form-select">
                <option disabled selected>Escolha um conhecimento...</option>
                <option>Anatomia</option>
                <option>Alquimia</option>
                <option>Animais</option>
                <option>Crime</option>
                <option>Dan√ßa</option>
                <option>Estudos</option>
                <option>Forja</option>
                <option>Guerra</option>
                <option>Hist√≥ria</option>
                <option>Magia</option>
                <option>Mecanismos</option>
                <option>M√∫sica</option>
                <option>Nobreza</option>
                <option>Plantas</option>
                <option>Sobreviv√™ncia</option>
            </select>

            <button type="button" class="btn btn-secondary" onclick="addConhecimento()">Adicionar</button>
        </div>
        <ul id="pjListaConhecimentos" class="list-group mt-2"></ul>

          <hr>
          <h5>Habilidades (at√© 12)</h5>
          <div class="d-flex gap-2">
            <button type="button" class="btn btn-primary" onclick="abrirHabClasse()">
                Adicionar habilidade da classe
            </button>
            <button type="button" class="btn btn-secondary" onclick="abrirHabGeral()">
                Adicionar habilidade geral
            </button>

          </div>
          <ul id="pjListaHabilidades" class="list-group mt-2"></ul>

          <hr>
          <h5>Mochila (at√© 10)</h5>
          <div class="mt-3">
            <label class="form-label"><b>Mochila</b></label>
            <div id="listaMochila"></div>
            <button type="button" class="btn btn-sm btn-primary mt-2" onclick="abrirModalAdicionarMochila()">
                Adicionar Item
            </button>
        </div>
        </form>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button id="salvarPjBtn" class="btn btn-primary">Salvar</button>
      </div>

    </div>
  </div>
</div>

<!-- MODAL ADICIONAR/EDITAR MOCHILA -->
<div class="modal fade" id="modalMochila" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Item da Mochila</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <label class="form-label">Nome</label>
        <input id="mochilaNome" class="form-control">

        <label class="form-label mt-3">Descri√ß√£o</label>
        <textarea id="mochilaDescricao" rows="3" class="form-control"></textarea>

      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-success" onclick="salvarItemMochila()">Salvar</button>
      </div>

    </div>
  </div>
</div>


<!-- Modal para escolher habilidade da classe -->
<div class="modal fade" id="modalAddHabClasse" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      
      <div class="modal-header">
        <h5 class="modal-title">Adicionar Habilidade da Classe</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <label class="form-label">Selecione uma habilidade:</label>
        <select id="selectHabClasse" class="form-select"></select>

      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="confirmarHabClasse()">Adicionar</button>
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>

    </div>
  </div>
</div>

<div class="modal fade" id="modalHabGeral">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Habilidades Gerais Dispon√≠veis</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <select id="selectHabGeral" class="form-select"></select>
      </div>

      <div class="modal-footer">
        <button class="btn btn-primary" onclick="confirmarHabGeral()">Adicionar</button>
      </div>

    </div>
  </div>
</div>


<div class="modal fade" id="modalDetalhes" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">

      <div class="modal-header">
        <h5 id="modalDetalhesTitulo" class="modal-title">Detalhes do PJ</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body" id="modalDetalhesCorpo">
        <!-- conte√∫do preenchido dinamicamente -->
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal" onclick="limparBackdrops()">Fechar</button>
      </div>

    </div>
  </div>
</div>

<div class="modal fade" id="modalEscolherArma">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Escolher Arma</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <select id="listaArmas" class="form-select mb-3">
          <option value="">Selecione uma arma</option>
          <option value="MAGICA">‚ú® Arma M√°gica</option>
        </select>

        <div id="previewArma"></div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-primary" onclick="confirmarEscolhaArma()">Adicionar</button>
      </div>

    </div>
  </div>
</div>

<!-- Modal: Detalhes dos Especiais da Arma -->
<div class="modal fade" id="modalDetalhesEspeciais" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Especiais da Arma</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body" id="modalDetalhesEspeciaisCorpo">
        <!-- preenchido via JS -->
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>

    </div>
  </div>
</div>

<!-- Modal: Selecionar Escudo -->
<div class="modal fade" id="modalSelecionarEscudo" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Escolher Escudo</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <select id="selectEscudo" class="form-select">
          <!-- Preenchido via JS -->
        </select>
      </div>

      <div class="modal-footer">
        <button class="btn btn-primary" onclick="confirmarEscudo()">Adicionar</button>
      </div>

    </div>
  </div>
</div>

<div class="modal fade" id="modalSelecionarVestimenta" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Escolher Vestimenta</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <select id="selectVestimenta" class="form-select"></select>
      </div>

      <div class="modal-footer">
        <!-- ‚≠ê BOT√ÉO NOVO AQUI ‚≠ê -->
        <button class="btn btn-warning" onclick="gerarVestimentaMagica()">
          ‚ú® Gerar Vestimenta M√°gica
        </button>

        <button class="btn btn-primary" onclick="confirmarVestimenta()">Adicionar</button>
      </div>

    </div>
  </div>
</div>

<div class="modal fade" id="modalEspeciaisVestimenta">
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Especiais da Vestimenta</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body" id="conteudoEspeciaisVestimenta"></div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>

    </div>
  </div>
</div>

<!-- Modal Selecionar Habilidade -->
<div class="modal fade" id="modalHabilidadeClasse">
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Selecionar Habilidade da Classe</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <select id="selectHabilidadeClasse" class="form-select"></select>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-primary" onclick="confirmarHabilidadeClasse()">Adicionar</button>
      </div>

    </div>
  </div>
</div>

<div class="modal fade" id="modalDetalhesHabilidades">
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Detalhes das Habilidades</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body" id="conteudoDetalhesHabilidades">
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>

    </div>
  </div>
</div>

<div class="modal fade" id="modalHabEspecie">
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Habilidade da Esp√©cie</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body" id="conteudoHabEspecie">
      </div>

    </div>
  </div>
</div>

<div class="modal fade" id="modalItemMochila">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Item da Mochila</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body" id="conteudoItemMochila"></div>
    </div>
  </div>
</div>

<div class="modal fade" id="modalSelecionarMochila" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Adicionar Item √† Mochila</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <label class="form-label fw-bold">Selecione um item:</label>
        <select id="selectMochilaItem" class="form-select mb-3">
          <option value="">Selecione um item...</option>
        </select>

        <div id="previewMochilaItem"></div>

      </div>

      <div class="modal-footer">
        <button class="btn btn-primary" onclick="confirmarItemMochila()">Adicionar</button>
      </div>

    </div>
  </div>
</div>



</body>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="tabelas.js"></script>
<script src="functionsCenas.js"></script>
<script src="functionsCidades.js"></script>
<script src="functionsDungeon.js"></script>
<script src="functionsMissoes.js"></script>
<script src="functionsRumores.js"></script>
<script src="functionsEncontros.js"></script>
<script src="functionsPontosInteresse.js"></script>
<script src="functionsOraculo.js"></script>
<script src="functionsPNJ.js"></script>
<script src="functionsPJ.js"></script>
<script src="functionsCampanha.js"></script>
<script>

let mochilaEditIndex = null;
let mochilaTemp = [];    
// Rolagem
function d20() { return Math.floor(Math.random()*20)+1; }
function rolarD20() { return Math.floor(Math.random()*20)+1; }
function rolarD4() { return Math.floor(Math.random()*4)+1; }
function rolarD6() { return Math.floor(Math.random()*6)+1; }
function rolarD12() { return Math.floor(Math.random()*12)+1; }
function r(arr) {
    return arr[Math.floor(Math.random() * arr.length)];
}

function rolar(lista) {
    return lista[Math.floor(Math.random() * lista.length)];
}

function abrirSecao(id) {
  // esconder menu corretamente
  document.getElementById('menu').classList.add('d-none');

  // esconder outras se√ß√µes
  document.querySelectorAll('.secao').forEach(sec => sec.style.display = 'none');

  // mostrar se√ß√£o escolhida
  document.getElementById(id).style.display = 'block';

  // carregamentos din√¢micos por se√ß√£o
  if (id === 'sec-campanhas') {
    mostrarCampanhas();
    document.getElementById("campanhaAtualNome").innerText = campanhaAtual;
  } 
  else if (id === 'missoes') {
    atualizarListasMissoes();
  } 
  else if (id === 'sec-boatos') {
    atualizarListaRumores();
  }
  else if (id === 'sec-cidade') {
    atualizarListaCidades();
  }
  else if (id === 'sec-pi') {
    atualizarListaPI(); // <-- AQUI EST√Å A CORRE√á√ÉO!
  } else if (id === "sec-dungeon"){
    atualizarListaDungeons();
  } else if (id === "sec-diario") {
    atualizarListaCenas();
    atualizarCenaAtual()
  }else if (id === "sec-tabelas-oraculo") {
    atualizarTabelasOraculo();
  }else if (id === "pnjSection") {
    listarPNJs();
  }else if (id === "pjSection") {
    atualizarPJs();
  }
}

function voltarMenu() {
  // esconder se√ß√µes
  document.querySelectorAll('.secao').forEach(sec => sec.style.display = 'none');

  // mostrar o menu corretamente
  const menu = document.getElementById('menu');
  menu.classList.remove('d-none');
  menu.classList.add('d-grid');
}


function rolarD12() {
  return Math.floor(Math.random() * 12) + 1;
}

function rolar2d6() {
  return (Math.floor(Math.random()*6)+1) + "-" + (Math.floor(Math.random()*6)+1);
}



function rolar2d6Key() {
  const d1 = rolarD6();
  const d2 = rolarD6();
  return `${d1}-${d2}`;
}

function gerarTesouro() {
  const d = rolarD6();
  switch(d) {
    case 1:
    case 2:
      return 'Objeto Valioso';
    case 3:
      return 'Pedra Preciosa';
    case 4:
      return 'Item M√°gico (Vestimenta M√°gica)';
    case 5:
      return 'Item M√°gico (Arma M√°gica)';
    case 6:
      return 'Equipamento + Role novamente: ' + gerarTesouro();
  }
}

function rolarD10() {
  return Math.floor(Math.random() * 10) + 1;
}

// ----------------- Helpers -----------------

// =====================================
// üîÆ OR√ÅCULO DO DESTINO (usando destinoTabela)
// =====================================

// -------------------------
// üé≤ Rola d100
// -------------------------
function d100() {
  return Math.floor(Math.random() * 100) + 1;
}

// ------------------------------
// üé≤ Rola 2d10 (para Evento Caos)
// ------------------------------
function doisD10() {
  return {
    d1: Math.floor(Math.random() * 10) + 1,
    d2: Math.floor(Math.random() * 10) + 1
  };
}

function escapeHtml(unsafe) {
  return unsafe
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

// Remove tags HTML e mant√©m texto simples
function stripHtml(html) {
  const tmp = document.createElement("DIV");
  tmp.innerHTML = html;
  return tmp.textContent || tmp.innerText || "";
}

function abrirCriarPJ() {
  mochilaTemp = [];  
  document.getElementById("pjEditando").value = "";  
  document.getElementById("formCriarPJ").reset();
  document.getElementById("modalCriarPjTitulo").innerText = "Criar Novo PJ";
  document.getElementById("salvarPjBtn").onclick = salvarNovoPJ;

  new bootstrap.Modal(document.getElementById("modalCriarPJ")).show();
}

function salvarNovoPJ() {
  const index = document.getElementById("pjEditando").value;
    const pj = coletarDadosPJ();

    if (index === "") {
        // criar
        campanhas[campanhaAtual].pjs.push(pj);
    } else {
        // editar
        campanhas[campanhaAtual].pjs[index] = pj;
    }
  salvarCampanhas();
  listarPJs();

  bootstrap.Modal.getInstance(document.getElementById("modalCriarPJ")).hide();
}

function coletarArmas() {
  const armas = [];

  document.querySelectorAll("#pjArmas .card").forEach(card => {
    const arma = {
      nome: card.querySelector(".armaNome").value,
      dano: card.querySelector(".armaDano").value,
      critico: card.querySelector(".armaCritico").value,
      especial: card.querySelector(".armaEspecial").value
    };

    if (arma.nome.trim() !== "") {
      armas.push(arma);
    }
  });

  return armas;
}


function coletarDadosPJ() {
  return {
    nome: document.getElementById("pjNome").value,
    especie: document.getElementById("pjEspecie").value,
    origem: document.getElementById("pjOrigem").value,
    classe: document.getElementById("pjClasse").value,
    foco: document.getElementById("pjFoco").value,
    motivacao: document.getElementById("pjMotivacao").value,

    pv: {
      especie: document.getElementById("pjPVEspecie").value,
      classe:  document.getElementById("pjPVClasse").value,
      equip:   document.getElementById("pjPVEquip").value,
      max:     document.getElementById("pjPVMax").value,
      atual:   document.getElementById("pjPVAtual").value
    },

    pe: {
      especie: document.getElementById("pjPEEspecie").value,
      classe:  document.getElementById("pjPEClasse").value,
      equip:   document.getElementById("pjPEEquip").value,
      max:     document.getElementById("pjPEMax").value,
      atual:   document.getElementById("pjPEAtual").value
    },

    armas: coletarArmas(),
    escudos: Array.from(document.querySelectorAll("#pjEscudos .card")).map(div => ({
        nome: div.querySelector(".escudoNome")?.value || "",
        bloqueio: parseInt(div.querySelector(".escudoBloqueio")?.value || 0),
        custoPE: parseInt(div.querySelector(".escudoCusto")?.value || 0),
        especial: div.querySelector(".escudoEspecial")?.value || ""
    })),

    equipamentoVestido: coletarEquipVestido(),

    conhecimentos: Array.from(document.querySelectorAll("#pjListaConhecimentos .conhecimentoTexto"))
                   .map(span => span.textContent),
    habilidades: Array.from(document.querySelectorAll("#pjListaHabilidades li")).map(li => ({
    habilidade: li.querySelector(".habilidadeNome").textContent,
    PE: li.querySelector(".habilidadePE").textContent.replace("PE ", ""),
    descricao: li.querySelector(".habilidadeDescricao").textContent
    })),
    mochila: mochilaTemp
  };
}

function listarPJs() {
  const lista = document.getElementById("listaPJs");
  lista.innerHTML = "";

  campanhas[campanhaAtual].pjs.forEach((pj, i) => {
    lista.innerHTML += `
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <b>${pj.nome}</b>
        <span>
          <button class="btn btn-sm btn-info" onclick="detalharPJ(${i})">Detalhes</button>
          <button class="btn btn-sm btn-warning" onclick="editarPJ(${i})">Editar</button>
          <button class="btn btn-sm btn-danger" onclick="excluirPJ(${i})">Excluir</button>
        </span>
      </li>
    `;
  });
}


function detalharPJ(index) {
    const pj = campanhas[campanhaAtual].pjs[index];
    if (!pj) return;

    // ----- Armas -----
    const armasHTML = (pj.armas && pj.armas.length)
        ? pj.armas.map((a, i) => `
            <li class="mb-2">
                <b>${a.nome}</b> ‚Äî Dano: ${a.dano}, Cr√≠tico: ${a.critico}<br>
                <b>Especiais:</b> ${a.especial}
                <br>
                <button class="btn btn-sm btn-info mt-1" onclick="detalharEspeciaisPJ(${index}, ${i})">
                    Ver Especiais
                </button>
                <button class="btn btn-sm btn-warning" onclick="guardarArma(${index}, ${i})">
                    Guardar
                </button>
            </li>
        `).join("")
        : "<i>Nenhuma arma equipada</i>";

    // ----- Equipamentos -----
   const equipHTML = (pj.equipamentoVestido && pj.equipamentoVestido.length)
    ? pj.equipamentoVestido.map((e, i)=> `
        <div class="border p-2 my-2">
            <b>${e.nome}</b> ‚Äî ${e.tipo}<br>
            PV ${e.pv >= 0 ? "+"+e.pv : e.pv} | PE ${e.pe >= 0 ? "+"+e.pe : e.pe}<br>
            Especiais: ${Array.isArray(e.especial) ? e.especial.join(", ") : e.especial}
            <br>
            <button class="btn btn-sm btn-info mt-1" onclick="detalharEspeciaisVestimenta(${index}, ${i})">
                Ver Especiais
            </button>
            <button class="btn btn-sm btn-warning" onclick="guardarVestimenta(${index}, ${i})">
                Guardar
            </button>
        </div>
    `).join("")
    : "<i>Nenhum</i>";

    const conhecimentosHTML = pj.conhecimentos.length
        ? pj.conhecimentos.map(c => `<li>${c}</li>`).join("")
        : "<i>Nenhum</i>";

    const habilidadesHTML = pj.habilidades.length
    ? `
        <ul>
            ${pj.habilidades.map(h => `
                <li><b>${h.habilidade}</b> ‚Äî PE ${h.PE}</li>
            `).join("")}
        </ul>

        <button class="btn btn-sm btn-info mt-2"
            onclick="detalharTodasHabilidades(${index})">
            Ver detalhes das habilidades
        </button>
    `
    : "<i>Nenhuma</i>";

    const mochilaHTML = pj.mochila.length
    ? pj.mochila.map((m, idx)=> {

        // Verificar tipo do item
        const isOutro = m.tipoItem === "Outro";
        const isPocao = m.nome.toLowerCase().includes("po√ß√£o");
        const isElixir = m.nome.toLowerCase().includes("elixir");

        let botaoAcao = "";

        if (isPocao || isElixir) {
            botaoAcao = `
                <button class="btn btn-sm btn-warning" 
                        onclick="usarPocao(${index}, ${idx})">
                    Usar
                </button>
            `;
        } 
        else if (isOutro) {
            botaoAcao = `
                <button class="btn btn-sm btn-danger" 
                        onclick="removerItemMochilaDireto(${index}, ${idx})">
                    Remover
                </button>
            `;
        } 
        else {
            botaoAcao = `
                <button class="btn btn-sm btn-success" 
                        onclick="equiparItemMochila(${index}, ${idx})">
                    Equipar
                </button>
            `;
        }

        return `
        <div class="border p-2 my-1">
            <b>${m.nome}</b>
            <button class="btn btn-sm btn-info" onclick="detalharItemMochila(${index}, ${idx})">
                Ver Detalhes
            </button>
            ${botaoAcao}
        </div>
        `;
    }).join("")
    : "<i>Vazia</i>";

    // ----- DETALHES DO PJ -----
    document.getElementById("modalDetalhesTitulo").innerText = pj.nome;

    document.getElementById("modalDetalhesCorpo").innerHTML = `
        <p>
            <b>Esp√©cie:</b> ${pj.especie}
            <button class="btn btn-sm btn-info ms-2"
                    onclick="mostrarHabEspecie('${pj.especie}')">
                    Habilidade da Esp√©cie
            </button>
        </p><br>
        <b>Origem:</b> ${pj.origem}<br>
        <b>Classe:</b> ${pj.classe}<br>
        <b>Foco:</b> ${pj.foco}<br>
        <b>Motiva√ß√£o:</b> ${pj.motivacao}<br><br>

        <h5>‚ú® Pontos de Vida</h5>
        <b>PV (Esp√©cie):</b> ${pj.pv.especie} &nbsp; 
        <b>PV (Classe):</b> ${pj.pv.classe} &nbsp;
        <b>PV (Equip):</b> ${pj.pv.equip} <br>
        <b>M√°ximo:</b> ${pj.pv.max} &nbsp; | &nbsp;
        <b>Atual:</b> ${pj.pv.atual}<br><br>

        <h5>üî∑ Pontos de Energia</h5>
        <b>PE (Esp√©cie):</b> ${pj.pe.especie} &nbsp; 
        <b>PE (Classe):</b> ${pj.pe.classe} &nbsp;
        <b>PE (Equip):</b> ${pj.pe.equip} <br>
        <b>M√°ximo:</b> ${pj.pe.max} &nbsp; | &nbsp;
        <b>Atual:</b> ${pj.pe.atual}<br><br>


        <h5>üó° Armas em M√£os</h5>
        <ul>${armasHTML}</ul>

        <h5>üõ° Equipamento Vestido</h5>
        <ul>${equipHTML}</ul>

        <h5>üìö Conhecimentos</h5>
        <ul>${conhecimentosHTML}</ul>

        <h5>‚ú® Habilidades</h5>
        <ul>${habilidadesHTML}</ul>

        <h5>üéí Mochila</h5>
        <ul>${mochilaHTML}</ul>

        <br>
        <button class="btn btn-primary" onclick="editarPJ(${index})">Editar</button>
    `;

    new bootstrap.Modal(document.getElementById("modalDetalhes")).show();
}

function detalharEspeciaisPJ(pjIndex, armaIndex) {
    const pj = campanhas[campanhaAtual]?.pjs?.[pjIndex];
    if (!pj) return alert("PJ n√£o encontrado.");

    const arma = pj.armas?.[armaIndex];
    if (!arma) return alert("Arma n√£o encontrada.");

    // normatiza lista de especiais
    let especiais = [];
    if (arma.especial) {
        if (Array.isArray(arma.especial)) {
            especiais = arma.especial.map(s => String(s).trim());
        } else {
            especiais = String(arma.especial).split(";").map(s => s.trim());
        }
    }

    // efeitos de arma m√°gica (arma.efeitos existe apenas para m√°gicas)
    let efeitosMagicos = [];
    if (Array.isArray(arma.efeitos)) {
        efeitosMagicos = arma.efeitos.map(s => String(s).trim());
    }

    function montarEspeciais(nomes) {
        if (!nomes.length) return "<i>Nenhum</i>";

        return nomes.map(nome => {
            const desc = descritoresAm.find(d => d.nome.toLowerCase() === nome.toLowerCase());
            if (desc) {
                return `<b>${desc.nome}</b>: ${desc.efeito}<br>`;
            }
            return `<b>${nome}</b>: <i>Sem descri√ß√£o encontrada</i><br>`;
        }).join("");
    }

    const html = `
        <h4>${arma.nome}</h4>
        <p><b>Dano:</b> ${arma.dano} | <b>Cr√≠tico:</b> ${arma.critico}</p>

        <h5>‚≠ê Especiais Normais</h5>
        ${montarEspeciais(especiais)}
        <hr>

        <h5>‚ú® Especiais M√°gicos</h5>
        ${efeitosMagicos.length ? montarEspeciais(efeitosMagicos) : "<i>Esta arma n√£o possui efeitos m√°gicos</i>"}
    `;

    document.getElementById("modalDetalhesEspeciaisCorpo").innerHTML = html;
    new bootstrap.Modal(document.getElementById("modalDetalhesEspeciais")).show();
}


function editarPJ(index) {
    const pj = campanhas[campanhaAtual].pjs[index];
    if (!pj) return;

    document.getElementById("modalCriarPjTitulo").innerText = "Editar Personagem";

    // --- CAMPOS B√ÅSICOS ---
    document.getElementById("pjNome").value = pj.nome;
    document.getElementById("pjEspecie").value = pj.especie;
    document.getElementById("pjOrigem").value = pj.origem;
    document.getElementById("pjClasse").value = pj.classe;
    document.getElementById("pjFoco").value = pj.foco;
    document.getElementById("pjMotivacao").value = pj.motivacao;

    // --- PV ---
    document.getElementById("pjPVEspecie").value = pj.pv.especie;
    document.getElementById("pjPVClasse").value = pj.pv.classe;
    document.getElementById("pjPVEquip").value = pj.pv.equip;
    document.getElementById("pjPVMax").value = pj.pv.max;
    document.getElementById("pjPVAtual").value = pj.pv.atual;

    // --- PE ---
    document.getElementById("pjPEEspecie").value = pj.pe.especie;
    document.getElementById("pjPEClasse").value = pj.pe.classe;
    document.getElementById("pjPEEquip").value = pj.pe.equip;
    document.getElementById("pjPEMax").value = pj.pe.max;
    document.getElementById("pjPEAtual").value = pj.pe.atual;

    // --- ARMAS ---
    const armasDiv = document.getElementById("pjArmas");
    armasDiv.innerHTML = "";

    (pj.armas || []).forEach(a => {
        const div = document.createElement("div");
        div.className = "card p-2 my-2";

        div.innerHTML = `
            <div class="row g-2">

              <div class="col">
                <label class="form-label">Nome da Arma</label>
                <input class="form-control armaNome" value="${a.nome}">
              </div>

              <div class="col">
                <label class="form-label">Dano</label>
                <input class="form-control armaDano" value="${a.dano}">
              </div>

              <div class="col">
                <label class="form-label">Cr√≠tico</label>
                <input class="form-control armaCritico" value="${a.critico}">
              </div>

              <div class="col">
                <label class="form-label">Especial</label>
                <input class="form-control armaEspecial" value="${a.especial}">
              </div>

              <div class="col-1 d-flex align-items-end">
                <button class="btn btn-sm btn-danger" 
                        onclick="this.parentElement.parentElement.parentElement.remove();">
                  X
                </button>
              </div>

            </div>
        `;

        armasDiv.appendChild(div);
    });

    const equipDiv = document.getElementById("pjEquipVestido");
    equipDiv.innerHTML = "";
    (pj.equipamentoVestido || []).forEach(e => {
        const div = document.createElement("div");
        div.className = "card p-2 my-2";

        div.innerHTML = `
        <div class="row g-2">

          <div class="col">
            <label class="form-label">Nome</label>
            <input class="form-control equipNome" value="${e.nome}" readonly>
          </div>

          <div class="col">
            <label class="form-label">Tipo</label>
            <input class="form-control equipTipo" value="${e.tipo}" readonly>
          </div>

          <div class="col">
            <label class="form-label">PV</label>
            <input class="form-control equipPV" value="${e.pv}" readonly>
          </div>

          <div class="col">
            <label class="form-label">PE</label>
            <input class="form-control equipPE" value="${e.pe}" readonly>
          </div>

          <div class="col">
            <label class="form-label">Especial</label>
            <input class="form-control equipEspecial" value="${e.especial}" readonly>
          </div>

          <div class="col-1 d-flex align-items-center">
            <button class="btn btn-sm btn-danger"
                    onclick="this.parentElement.parentElement.parentElement.remove(); atualizarPVPEEquip();">
              X
            </button>
          </div>

        </div>
    `;

    equipDiv.appendChild(div);
    });

    // --- CONHECIMENTOS ---
    const listaConhec = document.getElementById("pjListaConhecimentos");
    listaConhec.innerHTML = "";

    (pj.conhecimentos || []).forEach(c => {
        const li = document.createElement("li");
        li.className = "list-group-item d-flex justify-content-between align-items-center";
        li.innerHTML = `${c} 
            <button class="btn btn-sm btn-danger" onclick="this.parentElement.remove()">X</button>`;
        listaConhec.appendChild(li);
    });

    // --- HABILIDADES ---
    const habLista = document.getElementById("pjListaHabilidades");
    habLista.innerHTML = "";

    pj.habilidades.forEach(h => {
        const li = document.createElement("li");
        li.className = "list-group-item d-flex justify-content-between align-items-start";

        li.innerHTML = `
            <div>
                <span class="habilidadeNome"><b>${h.habilidade}</b></span>
                ‚Äî <span class="habilidadePE">PE ${h.PE}</span>
            </div>
            <button class="btn btn-sm btn-danger" onclick="this.parentElement.remove()">X</button>
            <span class="habilidadeDescricao" style="display:none">${h.descricao}</span>
        `;

        habLista.appendChild(li);
    });

    // --- MOCHILA ---
    carregarPJNosCampos(pj);

    // --- SALVAR O √çNDICE ---
    document.getElementById("pjEditando").value = index;
    document.getElementById("salvarPjBtn").onclick = salvarNovoPJ;

    setTimeout(() => {
        conectarEventosEspecieClasse();
        conectarEventosEquipamentos();

        atualizarEspeciePVPE();
        atualizarPVPEClasse();
        atualizarPVPEEquip();
        atualizarTotaisPVPE();
    }, 80);

    new bootstrap.Modal(document.getElementById("modalCriarPJ")).show();
}


function atualizarPJs() {
    listarPJs();
}

function excluirPJ(index) {
    if (!confirm("Excluir este PJ?")) return;

    campanhas[campanhaAtual].pjs.splice(index, 1);
    salvarCampanhas();
    listarPJs();
}



function abrirEscolhaArma() {
    const sel = document.getElementById("listaArmas");
    sel.innerHTML = `
      <option value="">Selecione uma arma</option>
      <option value="MAGICA">‚ú® Arma M√°gica</option>
    `;

    armasLista.forEach((a, i) => {
        sel.innerHTML += `<option value="${i}">${a.Nome} (${a.Tipo})</option>`;
    });

    document.getElementById("previewArma").innerHTML = "";

    new bootstrap.Modal(document.getElementById("modalEscolherArma")).show();
}

document.getElementById("listaArmas").addEventListener("change", function() {
    const value = this.value;

    if (value === "MAGICA") {
        document.getElementById("previewArma").innerHTML =
            `<div class="alert alert-info">A arma m√°gica ser√° gerada por l√≥gica especial futura!</div>`;
        return;
    }

    if (value === "") {
        document.getElementById("previewArma").innerHTML = "";
        return;
    }

    const arma = armasLista[value];

    document.getElementById("previewArma").innerHTML = `
        <div class="card p-2">
            <b>${arma.Nome}</b><br>
            Tipo: ${arma.Tipo}<br>
            Dano: ${arma.Dano}<br>
            Cr√≠tico: ${arma.Critico}<br>
            Especial: ${arma.Especial}
        </div>
    `;
});

function confirmarEscolhaArma() {
    const sel = document.getElementById("listaArmas").value;

    if (!sel) return alert("Escolha uma arma.");

    if (sel === "MAGICA") {

        const a = gerarArmaMagica();
        if (!a) return;

        // Cria um novo card de arma automaticamente
        adicionarArmaComValores(
            a.nome,
            a.dano,
            a.critico,
            a.especial.join("; ")
        );

        // Guarda os efeitos m√°gicos no √∫ltimo card criado
        const cards = document.querySelectorAll("#pjArmas .card");
        const ultimo = cards[cards.length - 1];
        ultimo.querySelector(".armaEspecial").dataset.efeitos = JSON.stringify(a.efeitos);

        bootstrap.Modal.getInstance(document.getElementById("modalEscolherArma")).hide();
        return;
    }

    const arma = armasLista[sel];

    adicionarArmaComValores(arma.Nome, arma.Dano, arma.Critico, arma.Especial);

    bootstrap.Modal.getInstance(document.getElementById("modalEscolherArma")).hide();
}

function adicionarArmaComValores(nome, dano, critico, especial) {
    const armasDiv = document.getElementById("pjArmas");

    const div = document.createElement("div");
    div.className = "card p-2 my-2";
    div.innerHTML = `
        <div class="row g-2">

          <div class="col">
            <label class="form-label">Nome</label>
            <input class="form-control armaNome" value="${nome}">
         </div>
         <div class="col">
            <label class="form-label">Dano</label>
            <input class="form-control armaDano" value="${dano}">
         </div>
         <div class="col">
            <label class="form-label">Cr√≠tico</label>
            <input class="form-control armaCritico" value="${critico}">
         </div>
         <div class="col">
            <label class="form-label">Especial</label>
            <input class="form-control armaEspecial" value="${especial}">
         </div>
          
          <div class="col-1 d-flex align-items-center">
            <button class="btn btn-sm btn-danger" onclick="this.parentElement.parentElement.parentElement.remove()">X</button>
          </div>
        </div>
        `;

    armasDiv.appendChild(div);
}

function gerarArmaMagica() {

    // 1. Rolagens das tabelas
    const parte1 = r(amParte1);
    const parte2 = r(amParte2);
    const parte3 = r(amParte3);

    // 2. Buscar arma base
    const nomeBase = armaMagicaMap[parte1] || parte1;

    const armaBase = armasLista.find(a => a.Nome.toLowerCase() === nomeBase.toLowerCase());

    if (!armaBase) {
        alert("Erro: arma base n√£o encontrada para " + parte1);
        return null;
    }

    // 3. Encontrar descritores usados
    const desc1 = descritoresAm.find(d => parte2.includes(d.nome)) || null;
    const desc2 = descritoresAm.find(d => parte3.includes(d.nome)) || null;

    // 4. Criar arma m√°gica final
    const arma = {
        nome: `${armaBase.Nome} ${parte2} ${parte3}`,
        tipo: armaBase.Tipo,
        dano: armaBase.Dano,
        critico: armaBase.Critico,
        especial: [],
        efeitos: []
    };

    // pegar o Especial base
    if (armaBase.Especial && armaBase.Especial !== "-") {
        arma.especial = armaBase.Especial.split(";").map(s => s.trim());
    }

    // adicionar o nome dos descritores como "habilidades m√°gicas"
    if (desc1) {
        arma.especial.push(desc1.nome);
        arma.efeitos.push(desc1.efeito);
    }
    if (desc2) {
        arma.especial.push(desc2.nome);
        arma.efeitos.push(desc2.efeito);
    }

    return arma;
}


function preencherEscudoMagico(e) {
    const escudosDiv = document.getElementById("pjEscudos");

    const div = document.createElement("div");
    div.className = "card p-2 my-2";

    div.innerHTML = `
        <div class="row g-2">

            <div class="col">
                <label class="form-label">Nome</label>
                <input class="form-control escudoNome" value="${e.nome}" readonly>
            </div>

            <div class="col">
                <label class="form-label">Bloqueio</label>
                <input class="form-control escudoBloqueio" value="${e.bloqueio}" readonly>
            </div>

            <div class="col">
                <label class="form-label">Custo</label>
                <input class="form-control escudoCusto" value="${e.custoPE}" readonly>
            </div>

            <div class="col">
                <label class="form-label">Especial</label>
                <input class="form-control escudoEspecial" value="${e.especial.join("; ")}" readonly>
            </div>

            <div class="col-1 d-flex align-items-center">
                <button class="btn btn-sm btn-danger"
                        onclick="this.parentElement.parentElement.parentElement.remove()">
                    X
                </button>
            </div>
        </div>
    `;

    escudosDiv.appendChild(div);
}

function coletarMochila() {
    return Array.from(document.querySelectorAll(".item-mochila")).map(div => {
        return {
            nome: div.dataset.nome,
            descricao: div.dataset.descricao
        };
    });
}

function detalharItemMochila(pjIndex, itemIndex) {
    const pj = campanhas[campanhaAtual].pjs[pjIndex];
    const item = pj.mochila[itemIndex];

    document.getElementById("conteudoItemMochila").innerHTML = `
        <h5>${item.nome}</h5>
        <p>${item.descricao}</p>
    `;

    new bootstrap.Modal(document.getElementById("modalItemMochila")).show();
}


function equiparItemMochila(pjIndex, itemIndex) {
    const pj = campanhas[campanhaAtual].pjs[pjIndex];
    const pack = pj.mochila[itemIndex];

    if (!pack || !pack.item || !pack.tipoItem) {
        alert("Item inv√°lido.");
        return;
    }

    const item = pack.item;

    switch(pack.tipoItem) {
        case "Arma":
            pj.armas.push(item);
            break;
        case "Escudo":
            pj.escudos.push(item);
            break;
        case "Vestimenta":
            pj.equipamentoVestido.push(item);
            break;
        default:
            alert("Tipo desconhecido.");
            return;
    }

    pj.mochila.splice(itemIndex, 1);
    salvarCampanhas();
    detalharPJ(pjIndex);
}


function reconstruirArma(item) {
    const dano = item.descricao.match(/Dano:\s*(\d+)/i)?.[1] || "1";
    const crit = item.descricao.match(/Cr√≠tico:\s*(\d+)/i)?.[1] || "6";
    const esp  = item.descricao.match(/Especial:\s*([\w\s,;]+)/i)?.[1] || "-";

    return {
        nome: item.nome,
        dano,
        critico: crit,
        especial: esp
    };
}

function reconstruirEscudo(item) {
    const bloq = item.descricao.match(/Bloqueio:\s*(\d+)/i)?.[1] || 1;
    const custo = item.descricao.match(/Custo:\s*(\d+)/i)?.[1] || 0;
    const esp = item.descricao.match(/Especial:\s*([\w\s,;]+)/i)?.[1] || "-";

    return {
        nome: item.nome,
        bloqueio: Number(bloq),
        custoPE: Number(custo),
        especial: esp
    };
}

function reconstruirVestimenta(item) {
    const pv = item.descricao.match(/PV\s*([+-]?\d+)/i)?.[1] || 0;
    const pe = item.descricao.match(/PE\s*([+-]?\d+)/i)?.[1] || 0;
    const esp = item.descricao.match(/Especial:\s*([\w\s,;]+)/i)?.[1] || "-";

    return {
        nome: item.nome,
        tipo: "Vestimenta",
        pv: Number(pv),
        pe: Number(pe),
        especial: esp
    };
}

function abrirModalAdicionarMochila() {
    const sel = document.getElementById("selectMochilaItem");
    sel.innerHTML = `<option value="">Selecione um item...</option>`;

    outrosEquip.forEach((item, i) => {
        const op = document.createElement("option");
        op.value = i;
        op.textContent = `${item.nome} ‚Äî (${item.acesso})`;
        sel.appendChild(op);
    });
    const modal = new bootstrap.Modal(document.getElementById("modalSelecionarMochila"), {
        backdrop: 'static',
        keyboard: false
    });

    modal.show();
    document.getElementById("modalSelecionarMochila")
    .addEventListener("submit", e => e.preventDefault());
}

function mostrarDetalhesItemMochila(index) {
    const item = mochilaTemp[index];

    document.getElementById("conteudoItemMochila").innerHTML = `
        <h5>${item.nome}</h5>
        <p>${item.descricao}</p>
    `;

    new bootstrap.Modal(document.getElementById("modalItemMochila")).show();
}

function editarItemMochila(index) {
    const item = mochilaTemp[index];
    mochilaEditIndex = index;

    document.getElementById("mochilaNome").value = item.nome;
    document.getElementById("mochilaDescricao").value = item.descricao;

    new bootstrap.Modal(document.getElementById("modalMochila")).show();
}

function salvarItemMochila() {
    const nome = document.getElementById("mochilaNome").value.trim();
    const desc = document.getElementById("mochilaDescricao").value.trim();

    if (!nome) return alert("O item precisa ter um nome.");

    const item = { nome, descricao: desc };

    if (mochilaEditIndex === null) {
        mochilaTemp.push(item);
    } else {
        mochilaTemp[mochilaEditIndex] = item;
    }

    bootstrap.Modal.getInstance(document.getElementById("modalMochila")).hide();
    renderizarMochilaTemp();
}

function removerItemMochila(index) {
    if (!confirm("Remover este item?")) return;
    mochilaTemp.splice(index, 1);
    renderizarMochilaTemp();
}

function renderizarMochilaTemp() {
    const div = document.getElementById("listaMochila");

    if (!mochilaTemp.length) {
        div.innerHTML = "<i>Nenhum item na mochila.</i>";
        return;
    }

    div.innerHTML = mochilaTemp.map((item, i) => `
        <div class="border p-2 mb-2 rounded">
            <b>${item.nome}</b>
            <button class="btn btn-sm btn-danger float-end"
                onclick="removerItemMochila(${i})">X</button>
        </div>
    `).join("");
}

function carregarPJNosCampos(pj) {
    mochilaTemp = JSON.parse(JSON.stringify(pj.mochila || []));
    renderizarMochilaTemp();
}

function guardarArma(pjIndex, armaIndex) {
    const pj = campanhas[campanhaAtual].pjs[pjIndex];
    const arma = pj.armas[armaIndex];

    if (!pj.mochila) pj.mochila = [];

    let especiais = [];
    if (arma.especial) {
        if (Array.isArray(arma.especial)) especiais = arma.especial;
        else especiais = arma.especial.split(";").map(s => s.trim());
    }

    const descricao =
        `Dano: ${arma.dano} | ` +
        `Cr√≠tico: ${arma.critico}` +
        (especiais.length ? ` | Especiais: ${especiais.join(", ")}` : "") +
        (arma.efeitos ? ` | Efeitos M√°gicos: ${arma.efeitos.join(", ")}` : "");

    pj.mochila.push({
        nome: arma.nome,
        tipoItem: "Arma",
        descricao,
        item: arma
    });

    pj.armas.splice(armaIndex, 1);
    salvarCampanhas();
    detalharPJ(pjIndex);
}



function guardarEscudo(pjIndex, escudoIndex) {
    const pj = campanhas[campanhaAtual].pjs[pjIndex];
    const esc = pj.escudos[escudoIndex];

    if (!pj.mochila) pj.mochila = [];

    let especiais = [];
    if (esc.especial) {
        if (Array.isArray(esc.especial)) especiais = esc.especial;
        else especiais = esc.especial.split(";").map(s => s.trim());
    }

    const descricao =
        `Bloqueio: ${esc.bloqueio} | ` +
        `Custo PE: ${esc.custoPE}` +
        (especiais.length ? ` | Especiais: ${especiais.join(", ")}` : "");

    pj.mochila.push({
        nome: esc.nome,
        tipoItem: "Escudo",
        descricao,
        item: esc
    });

    pj.escudos.splice(escudoIndex, 1);
    salvarCampanhas();
    detalharPJ(pjIndex);
}

function guardarVestimenta(pjIndex, vestIndex) {
    const pj = campanhas[campanhaAtual].pjs[pjIndex];
    const vest = pj.equipamentoVestido[vestIndex];

    if (!pj.mochila) pj.mochila = [];

    let especiais = [];
    if (vest.especial) {
        if (Array.isArray(vest.especial)) especiais = vest.especial;
        else especiais = vest.especial.split(";").map(s => s.trim());
    }

    const descricao =
        `Tipo: ${vest.tipo} | ` +
        `PV: ${vest.pv >= 0 ? "+" + vest.pv : vest.pv} | ` +
        `PE: ${vest.pe >= 0 ? "+" + vest.pe : vest.pe}` +
        (especiais.length ? ` | Especiais: ${especiais.join(", ")}` : "");

    pj.mochila.push({
        nome: vest.nome,
        tipoItem: "Vestimenta",
        descricao,
        item: vest
    });

    pj.equipamentoVestido.splice(vestIndex, 1);
    salvarCampanhas();
    detalharPJ(pjIndex);
}

function limparBackdrops() {
    document.querySelectorAll(".modal-backdrop").forEach(b => b.remove());
    document.body.classList.remove("modal-open");
    document.body.style.removeProperty("overflow");
    document.body.style.removeProperty("padding-right");
}



document.getElementById("selectMochilaItem").addEventListener("change", function() {
    const idx = this.value;
    const preview = document.getElementById("previewMochilaItem");

    if (idx === "") {
        preview.innerHTML = "";
        return;
    }

    const item = outrosEquip[idx];

    preview.innerHTML = `
        <div class="card p-2">
            <b>${item.nome}</b><br>
            <i>Acesso:</i> ${item.acesso}<br>
            <p class="mt-2">${item.descricao}</p>
        </div>
    `;
});

function confirmarItemMochila() {
    const idx = document.getElementById("selectMochilaItem").value;
    if (idx === "") return alert("Escolha um item.");

    const item = outrosEquip[idx];

    mochilaTemp.push({
        nome: item.nome,
        descricao: item.descricao,
        tipoItem: "Outro",
        item // salva objeto inteiro para expans√µes futuras
    });

    bootstrap.Modal.getInstance(document.getElementById("modalSelecionarMochila")).hide();
    renderizarMochilaTemp();
}

function removerItemMochilaDireto(pjIndex, itemIndex) {
    const pj = campanhas[campanhaAtual].pjs[pjIndex];

    if (!confirm("Deseja remover este item da mochila?")) return;

    pj.mochila.splice(itemIndex, 1);

    salvarCampanhas();
    detalharPJ(pjIndex);
}

function usarPocao(pjIndex, itemIndex) {
    const pj = campanhas[campanhaAtual].pjs[pjIndex];
    const item = pj.mochila[itemIndex];

    if (!confirm(`Usar ${item.nome}?`)) return;

    // Aqui no futuro podemos colocar efeitos diferentes para cada po√ß√£o.
    // Por enquanto apenas remove.
    pj.mochila.splice(itemIndex, 1);

    salvarCampanhas();
    detalharPJ(pjIndex);
}


function salvarMissoes() { salvarCampanhas(); }
function salvarRumores() { salvarCampanhas(); }

// Inicializar ao abrir a p√°gina
atualizarListaRumores();

atualizarListasMissoes();

atualizarListaCidades();

atualizarListaDungeons();

atualizarListaCenas();

atualizarListaPI();

atualizarTabelasOraculo();

atualizarCenaAtual();

atualizarPJs();

</script>
</html>


